<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>記帳網站</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">💰 我的記帳簿</h1>

    <!-- 新增資料表單 -->
    <form id="record-form" class="mb-4 d-flex gap-2 flex-wrap">
      <select id="type" class="form-select w-auto">
        <option value="支出">支出</option>
        <option value="收入">收入</option>
      </select>

      <!-- 項目選單（支出才出現） -->
      <select id="item" class="form-select w-auto">
        <option value="早餐">早餐</option>
        <option value="午餐">午餐</option>
        <option value="晚餐">晚餐</option>
        <option value="點心">點心</option>
        <option value="其他">其他</option>
      </select>

      <!-- 使用者自定義類別 -->
      <input id="customCategory" type="text" class="form-control w-auto" placeholder="請輸入其他類別" style="display: none" />

      <input type="number" id="amount" class="form-control w-auto" placeholder="金額" />
      <input type="date" id="date" class="form-control w-auto" />
      <button type="submit" class="btn btn-primary">新增</button>
    </form>

    <!-- 結餘顯示 -->
    <div id="summary" class="mb-3 fw-bold text-end"></div>

    <!-- 記帳清單 -->
    <ul id="record-list" class="list-group"></ul>
  </div>

  <script>
    const api = 'https://budget-app-1mt8.onrender.com/records';
    const form = document.getElementById('record-form');
    const typeSelect = document.getElementById('type');
    const itemSelect = document.getElementById('item');
    const customCategoryInput = document.getElementById('customCategory');
    const list = document.getElementById('record-list');
    const summary = document.getElementById('summary');

    // 類型改變：收入不顯示項目與自訂欄位
    typeSelect.addEventListener('change', () => {
      const isIncome = typeSelect.value === '收入';
      itemSelect.style.display = isIncome ? 'none' : 'inline';
      customCategoryInput.style.display = 'none';
    });

    // 選其他時顯示輸入框
    itemSelect.addEventListener('change', () => {
      customCategoryInput.style.display = itemSelect.value === '其他' ? 'inline' : 'none';
    });

    // 載入記錄
    async function loadRecords() {
      const res = await fetch(api);
      const records = await res.json();
      list.innerHTML = '';
      let total = 0;

      records.forEach(r => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const typeMark = r.type === '收入' ? '+' : '-';
        const displayItem = r.type === '收入' ? '收入' : (r.category || r.item);
        li.innerHTML = `<span>${r.date} - ${displayItem}：${typeMark}$${r.amount}</span>`;

        total += r.type === '收入' ? r.amount : -r.amount;

        const delBtn = document.createElement('button');
        delBtn.textContent = '刪除';
        delBtn.className = 'btn btn-danger btn-sm';
        delBtn.onclick = async () => {
          await fetch(api + '/' + r.id, { method: 'DELETE' });
          loadRecords();
        };
        li.appendChild(delBtn);
        list.appendChild(li);
      });

      summary.textContent = `目前結餘：$${total}`;
    }

    // 表單送出
    form.onsubmit = async (e) => {
      e.preventDefault();
      const type = typeSelect.value;
      const item = type === '收入' ? '收入' : itemSelect.value;
      const category = item === '其他' ? customCategoryInput.value : item;
      const amount = parseInt(form.amount.value);
      const date = form.date.value;

      const data = { item, amount, date, type, category };

      await fetch(api, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      form.reset();
      itemSelect.style.display = 'inline';
      customCategoryInput.style.display = 'none';
      loadRecords();
    };

    loadRecords();
  </script>
</body>
</html>
